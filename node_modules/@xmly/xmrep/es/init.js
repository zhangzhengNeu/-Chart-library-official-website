import { temData } from './functions/log/tracker';
import xmLog from './functions/log/report';
import { collectUtmInfo } from './functions/log/utm';
import { reportObj } from './share/report';
import { ss } from './utils/storage';
import { getAttr } from './utils/dom';
export default function (enableXmLog) {
    var onDoc = document.addEventListener || document.attachEvent;
    var onWindow = window.addEventListener || window.attachEvent;
    var hasPageHide = 'onpagehide' in window;
    onWindow(hasPageHide ? 'pageshow' : 'load', function () {
        enableXmLog && xmLog.init();
    });
    onWindow(hasPageHide ? 'pagehide' : 'unload', function () {
        reportObj.flush();
        if (xmLog.checkSending() || reportObj.checkSending()) {
            var isSleep = +new Date();
            while ((+new Date() - isSleep) < 300) {
                // 延时300ms
                // 解决rollup tree shaking问题
                console.log();
            }
        }
        if (enableXmLog) {
            if (temData.page && enableXmLog) {
                ss.set('srcPage', temData.page || '');
                ss.set('srcPageId', temData.pageId || '');
                ss.set('srcModule', temData.module || '');
                ss.set('srcPosition', temData.postion || '');
            }
            xmLog.flush();
        }
    });
    if (enableXmLog) {
        onDoc('click', function (oev) {
            var ev = oev || window.event;
            var target = (ev.target || ev.srcElement);
            while (target && getAttr(target, 'xmlog-spy') !== 'xm') {
                target = target.parentNode;
            }
            if (getAttr(target, 'xmlog-spy') === 'xm') {
                temData.module = getAttr(target, 'xmlog-mod') || '';
                temData.postion = getAttr(target, 'xmlog-pos') || '';
            }
        }, false);
        // 获取广告相关数据
        collectUtmInfo();
    }
}
